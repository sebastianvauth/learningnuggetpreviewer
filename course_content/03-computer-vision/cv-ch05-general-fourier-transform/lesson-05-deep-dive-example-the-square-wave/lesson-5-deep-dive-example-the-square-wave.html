<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0'>
<link rel="stylesheet" href="../../styles/lesson.css">
<style>
/* Specific styles for Fourier Convergence Interactive */
.visual-aid-container {
    margin: 2rem 0;
    padding: 25px;
    background: #ffffff;
    border: 2px solid #e2e8f0;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
}

#convergenceCanvas {
    width: 100%;
    height: 350px;
    background: #f8fafc;
    border-radius: 12px;
    display: block;
}

.legend {
    display: flex;
    justify-content: center;
    gap: 25px;
    margin: 20px 0;
    padding: 10px;
    background: #f1f5f9;
    border-radius: 8px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 0.9rem;
    font-weight: 600;
    color: #475569;
}

.dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

.dot.target { 
    border: 2px dashed #94a3b8; 
    background: transparent;
}

.dot.current { 
    background: #4facfe;
    box-shadow: 0 0 8px rgba(79, 172, 254, 0.5);
}

.controls-row {
    display: flex;
    justify-content: center;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 25px;
}

.stage-btn {
    padding: 12px 24px;
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 30px;
    color: #64748b;
    font-weight: 700;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.stage-btn:hover {
    border-color: #4facfe;
    color: #4facfe;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(79, 172, 254, 0.1);
}

.stage-btn.active {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
    border: none;
    box-shadow: 0 8px 20px rgba(79, 172, 254, 0.3);
}

@media (max-width: 768px) {
    #convergenceCanvas {
        height: 250px;
    }
    .legend {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    .stage-btn {
        padding: 10px 18px;
        font-size: 0.85rem;
        flex: 1 1 calc(50% - 12px);
    }
}
</style>
<title>Deep Dive Example ‚Äì The Square Wave</title>
<script>
window.MathJax = {
    tex: { inlineMath: [['\\(','\\)'], ['$', '$']] },
    options: { skipHtmlTags: ['script','noscript','style','textarea','pre','code'] }
};
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
</head>
<body>
<div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
<div class="lesson-container">

<section id="section1" class="visible">
    <div class="image-placeholder">
        <img src="images/1.jpg" alt="Square Wave oscillating between +1 and -1 with a period of 2 seconds. The transitions are instantaneous vertical lines.">
    </div>
    <h1>The Square Wave Challenge</h1>
    <h2>Theory to Practice</h2>
    <p>Theory is great, but can we actually use those scary-looking integrals to build the square wave we saw in Lesson 1? It's time to put the equations to the test. Let's do the math. Grab a pen‚Äîwe are going to derive the DNA of a square wave from scratch.</p>
    <div class="continue-button" onclick="showNextSection(2)">Continue</div>
</section>

<section id="section2">
    <h2>1. Defining the Signal</h2>
    <p>First, we need to rigorously define what we are analyzing. Let's look at a square wave \(y(t)\) with a period \(T=2\) seconds and an amplitude of \(\pm 1\).</p>
    <div class="continue-button" onclick="showNextSection(3)">Continue</div>
</section>

<section id="section3">
    <p>This means the fundamental angular frequency is \(\omega_0 = \frac{2\pi}{T} = \frac{2\pi}{2} = \pi\).</p>
    <div class="continue-button" onclick="showNextSection(4)">Continue</div>
</section>

<section id="section4">
    <p>Mathematically, the function looks like this over one period:</p>
    <p>$$ y(t) = \begin{cases} 1 & 0 \le t < 1 \\ -1 & 1 \le t < 2 \end{cases} $$</p>
    <div class="continue-button" onclick="showNextSection(5)">Continue</div>
</section>

<section id="section5">
    <p>Our goal is to find the coefficients \(a_0\), \(a_k\), and \(b_k\) to plug into the Fourier Series formula:</p>
    <p>$$ y(t) = a_0 + \sum_{k=1}^{\infty} [a_k \cos(k\pi t) + b_k \sin(k\pi t)] $$</p>
    <div class="continue-button" onclick="showNextSection(6)">Continue</div>
</section>

<section id="section6">
    <h2>2. The DC Component (a‚ÇÄ)</h2>
    <p>Let's start with the easy one: \(a_0\). This represents the average value of the signal over one period.</p>
    <div class="continue-button" onclick="showNextSection(7)">Continue</div>
</section>

<section id="section7">
    <p>Look at the graph below. The area of the positive part (from 0 to 1) is \(1 \times 1 = 1\). The area of the negative part (from 1 to 2) is \(1 \times -1 = -1\).</p>
    <div class="image-placeholder">
        <img src="images/2.jpg" alt="Area under the square wave curve shaded. The positive area is green and the negative area is red, demonstrating that they cancel each other out.">
    </div>
    <div class="continue-button" onclick="showNextSection(8)">Continue</div>
</section>

<section id="section8">
    <p>$$ a_0 = \frac{1}{T} \int_{0}^{T} y(t) dt = \frac{1}{2} (1 + (-1)) = 0 $$</p>
    <div class="continue-button" onclick="showNextSection(9)">Continue</div>
</section>

<section id="section9">
    <p>Since the positive and negative areas cancel each other out perfectly, the average is <strong>0</strong>. This means our wave is centered around the x-axis, with no DC offset.</p>
    <div class="continue-button" onclick="showNextSection(10)">Continue</div>
</section>

<section id="section10">
    <h2>3. The Cosine Coefficients (a‚Çñ)</h2>
    <p>Next, let's find the weights for the cosine terms (\(a_k\)). We need to evaluate:</p>
    <p>$$ a_k = \frac{2}{T} \int_{0}^{T} y(t) \cos(k\pi t) dt $$</p>
    <div class="continue-button" onclick="showNextSection(11)">Continue</div>
</section>

<section id="section11">
    <p>We could solve this integral the long way, or we can use a powerful shortcut: <strong>Symmetry</strong>.</p>
    <div class="vocab-section">
        <h3>Build Your Vocab</h3>
        <h4>Even and Odd Functions</h4>
        <p>An <strong>Even</strong> function is symmetric around the y-axis (\(f(t) = f(-t)\)), like \(\cos(t)\). An <strong>Odd</strong> function has rotational symmetry (\(f(t) = -f(-t)\)), like \(\sin(t)\) or our square wave defined around the origin.</p>
    </div>
    <div class="continue-button" onclick="showNextSection(12)">Continue</div>
</section>

<section id="section12">
    <p>Our square wave \(y(t)\) behaves like an <strong>Odd function</strong> (if we consider the pattern repeating). The Cosine function is an <strong>Even function</strong>.</p>
    
    <div class="test-your-knowledge">
        <h3>Check Your Understanding</h3>
        <h4>What happens when you multiply an Odd function by an Even function?</h4>
        <div class="multiple-choice">
            <div class="choice-option" data-correct="false" onclick="selectChoice(this, false, 'Not quite. Think about multiplying numbers: Negative x Positive = Negative.')">The result is Even</div>
            <div class="choice-option" data-correct="true" onclick="selectChoice(this, true, 'Correct! Just like (-1) x 1 = -1. An odd function multiplied by an even function results in an odd function.')">The result is Odd</div>
            <div class="choice-option" data-correct="false" onclick="selectChoice(this, false, 'The product isn\'t zero everywhere, but its integral might be!')">The result is Zero</div>
        </div>
    </div>
    <div class="continue-button" id="continue-after-odd-even" onclick="showNextSection(13)" style="display: none;">Continue</div>
</section>

<section id="section13">
    <p>When you integrate an <strong>Odd</strong> function (the product of \(y(t)\) and \(\cos\)) over a symmetric period, the positive and negative areas cancel out exactly. Therefore:</p>
    <p>$$ a_k = 0 \quad \text{for all } k $$</p>
    <p>This matches our intuition! A square wave starting at 0 looks 'sine-like', not 'cosine-like'. We don't need any cosines to build it.</p>
    <div class="continue-button" onclick="showNextSection(14)">Continue</div>
</section>

<section id="section14">
    <h2>4. The Sine Coefficients (b‚Çñ)</h2>
    <p>Now for the heavy lifting. Since we know the signal is 'sine-like', we expect these coefficients to be non-zero. The formula is:</p>
    <p>$$ b_k = \frac{2}{2} \int_{0}^{2} y(t) \sin(k\pi t) dt = \int_{0}^{2} y(t) \sin(k\pi t) dt $$</p>
    <div class="continue-button" onclick="showNextSection(15)">Continue</div>
</section>

<section id="section15">
    <p>Since \(y(t)\) changes from 1 to -1 at \(t=1\), we must split the integral into two parts:</p>
    <p>$$ b_k = \int_{0}^{1} (1)\sin(k\pi t) dt + \int_{1}^{2} (-1)\sin(k\pi t) dt $$</p>
    <div class="continue-button" onclick="showNextSection(16)">Continue</div>
</section>

<section id="section16">
    <p>Recall that the integral of \(\sin(ax)\) is \(-\frac{1}{a}\cos(ax)\). Let's solve the first part:</p>
    <p>$$ \left[ -\frac{\cos(k\pi t)}{k\pi} \right]_0^1 = -\frac{1}{k\pi}(\cos(k\pi) - \cos(0)) $$</p>
    <div class="continue-button" onclick="showNextSection(17)">Continue</div>
</section>

<section id="section17">
    <p>Since \(\cos(0) = 1\), this simplifies to:</p>
    <p>$$ \frac{1}{k\pi}(1 - \cos(k\pi)) $$</p>
    <div class="continue-button" onclick="showNextSection(18)">Continue</div>
</section>

<section id="section18">
    <p>If we do the math for the second part (from 1 to 2), remarkably, we get the exact same result! So we add them together:</p>
    <p>$$ b_k = \frac{2}{k\pi}(1 - \cos(k\pi)) $$</p>
    <div class="continue-button" onclick="showNextSection(19)">Continue</div>
</section>

<section id="section19">
    <p>Now, we have to evaluate this based on \(k\). This depends entirely on the term \(\cos(k\pi)\).</p>
    <div class="test-your-knowledge">
        <h3>Test Your Knowledge</h3>
        <h4>Why does the term \(\cos(k\pi)\) alternate between 1 and -1?</h4>
        <div class="multiple-choice">
            <div class="choice-option" data-correct="true" onclick="selectChoice(this, true, 'Exactly. For k=1, cos(œÄ)=-1. For k=2, cos(2œÄ)=1. It flips back and forth for every integer.')">Because cosine is a wave that oscillates between 1 and -1.</div>
            <div class="choice-option" data-correct="false" onclick="selectChoice(this, false, 'The limits determined the formula, but the alternating value comes from the nature of cosine itself.')">Because of the integration limits.</div>
        </div>
    </div>
    <div class="continue-button" id="continue-after-cos-test" onclick="showNextSection(20)" style="display: none;">Continue</div>
</section>

<section id="section20">
    <p>Let's plug in the numbers:</p>
    <p><strong>If \(k\) is Even</strong> (\(2, 4, 6...\)):<br>
    \(\cos(k\pi) = 1\).<br>
    \(b_k = \frac{2}{k\pi}(1 - 1) = 0\).</p>
    <p><strong>If \(k\) is Odd</strong> (\(1, 3, 5...\)):<br>
    \(\cos(k\pi) = -1\).<br>
    \(b_k = \frac{2}{k\pi}(1 - (-1)) = \frac{4}{k\pi}\).</p>
    <div class="continue-button" onclick="showNextSection(21)">Continue</div>
</section>

<section id="section21">
    <p>We have our answer! We only need <strong>Odd Harmonics</strong>, and their amplitude is \(\frac{4}{k\pi}\).</p>
    <div class="continue-button" onclick="showNextSection(22)">Continue</div>
</section>

<section id="section22">
    <h2>The Final Result</h2>
    <p>After all that calculus, we can write the final equation for our square wave:</p>
    <p>$$ y(t) = \sum_{k=odd}^{\infty} \frac{4}{k\pi} \sin(k\pi t) $$</p>
    <div class="continue-button" onclick="showNextSection(23)">Continue</div>
</section>

<section id="section23">
    <p>Written out, it looks like this:</p>
    <p>$$ y(t) = \frac{4}{\pi}\sin(\pi t) + \frac{4}{3\pi}\sin(3\pi t) + \frac{4}{5\pi}\sin(5\pi t) + \dots $$</p>
    <div class="continue-button" onclick="showNextSection(24)">Continue</div>
</section>

<section id="section24">
    <p>Notice that as the frequency gets higher (larger \(k\)), the amplitude gets smaller (\(\frac{1}{k}\)). This is why high-frequency details contribute less to the overall energy of the signal.</p>
    <!-- START VISUAL AID: FOURIER CONVERGENCE -->
<div class="visual-aid-container" id="fourier-convergence-module">
    <canvas id="convergenceCanvas"></canvas>
    
    <div class="legend">
        <div class="legend-item"><span class="dot target"></span> Perfect Square</div>
        <div class="legend-item"><span class="dot current"></span> Fourier Sum</div>
    </div>

    <div class="controls-row">
        <button class="stage-btn active" onclick="updateFourier(1, this)">Stage 1: Fundamental</button>
        <button class="stage-btn" onclick="updateFourier(3, this)">Stage 2: Add 3rd</button>
        <button class="stage-btn" onclick="updateFourier(5, this)">Stage 3: Add 5th</button>
        <button class="stage-btn" onclick="updateFourier(101, this)">Final: 50 Terms</button>
    </div>

    <script>
    (function() {
        const canvas = document.getElementById('convergenceCanvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('fourier-convergence-module');
        
        // Configuration
        let maxHarmonic = 1; // Current target k
        let currentRenderHarmonic = 1; // For animation interpolation
        
        // Handle High DPI and Visibility
        function resize() {
            const rect = canvas.getBoundingClientRect();
            if (rect.width === 0 || rect.height === 0) return;
            
            const dpr = window.devicePixelRatio || 1;
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            canvas.style.width = `${rect.width}px`;
            canvas.style.height = `${rect.height}px`;
            draw();
        }

        // The Mathematics
        function getFourierValue(t, harmonicCount) {
            let sum = 0;
            // We iterate up to the floor of harmonicCount
            const floorK = Math.floor(harmonicCount);
            
            for (let k = 1; k <= floorK; k += 2) {
                const term = (4 / (k * Math.PI)) * Math.sin(k * t * Math.PI);
                sum += term;
            }
            
            // For smooth animation, we add the next harmonic partially
            const nextK = (floorK % 2 === 0) ? floorK + 1 : floorK + 2;
            const fraction = harmonicCount - floorK;
            
            // Only add if nextK is still within our target range
            // This is a simple way to "fade in" the next harmonic's contribution
            if (fraction > 0 && nextK <= maxHarmonic) {
                 const term = (4 / (nextK * Math.PI)) * Math.sin(nextK * t * Math.PI);
                 sum += term * fraction;
            }
            
            return sum;
        }

        function draw() {
            const rect = canvas.getBoundingClientRect();
            const width = rect.width;
            const height = rect.height;
            if (width === 0 || height === 0) return;

            const centerY = height / 2;
            const scaleY = height / 3.5; // Amplitude scaling
            
            ctx.clearRect(0, 0, width, height);

            // 1. Draw Axis & Grid
            ctx.beginPath();
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            ctx.moveTo(0, centerY);
            ctx.lineTo(width, centerY);
            ctx.stroke();

            // 2. Draw Target Square Wave (Reference)
            ctx.beginPath();
            ctx.strokeStyle = '#cbd5e1';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            
            // One period: 0 to 2
            // We draw 2 periods for better visualization
            for (let x = 0; x <= width; x++) {
                const t = (x / width) * 2; 
                const targetY = (t % 2 < 1) ? 1 : -1;
                const plotY = centerY - (targetY * scaleY);
                if (x === 0) ctx.moveTo(x, plotY);
                else {
                    // Handle the vertical jump
                    const prevT = ((x-1) / width) * 2;
                    if (Math.floor(t) !== Math.floor(prevT)) {
                        ctx.lineTo(x, centerY - ((prevT % 2 < 1 ? 1 : -1) * scaleY));
                        ctx.lineTo(x, plotY);
                    }
                    ctx.lineTo(x, plotY);
                }
            }
            ctx.stroke();
            ctx.setLineDash([]); 

            // 3. Draw Fourier Sum
            ctx.beginPath();
            const gradient = ctx.createLinearGradient(0, 0, width, 0);
            gradient.addColorStop(0, '#4facfe');
            gradient.addColorStop(1, '#00f2fe');
            ctx.strokeStyle = gradient;
            ctx.lineWidth = 3;

            // Interpolate the harmonic count for smooth animation
            const diff = maxHarmonic - currentRenderHarmonic;
            if (Math.abs(diff) > 0.01) {
                currentRenderHarmonic += diff * 0.1; 
                requestAnimationFrame(draw);
            } else {
                currentRenderHarmonic = maxHarmonic;
            }

            for (let x = 0; x <= width; x++) {
                const t = (x / width) * 2; 
                const yVal = getFourierValue(t, currentRenderHarmonic);
                const plotY = centerY - (yVal * scaleY);
                if (x === 0) ctx.moveTo(x, plotY);
                else ctx.lineTo(x, plotY);
            }
            ctx.stroke();
        }

        // Global exposure for the button clicks
        window.updateFourier = function(k, btnElement) {
            maxHarmonic = k;
            
            const buttons = container.querySelectorAll('.stage-btn');
            buttons.forEach(b => b.classList.remove('active'));
            if (btnElement) btnElement.classList.add('active');
            
            draw();
        };

        // Use ResizeObserver for more reliable initialization and resizing
        const ro = new ResizeObserver(() => {
            resize();
        });
        ro.observe(canvas);

        window.addEventListener('resize', resize);
        // Initial check
        setTimeout(resize, 100);
    })();
    </script>
</div>
<!-- END VISUAL AID -->
    <div class="continue-button" onclick="showNextSection(25)">Continue</div>
</section>

<section id="section25">
    <p>This mathematical result perfectly matches the intuition we built in Lesson 1 using the sliders. We have proven that a square wave is just a sum of odd sine waves.</p>
    
    <div class="check-your-knowledge">
        <h3>Stop and Think</h3>
        <h4>What would happen to the coefficients if we shifted the square wave UP by +1, so it oscillated between 0 and 2 instead of -1 and 1?</h4>
        <p><em>Hint: Does the *shape* of the wave change, or just its position relative to 0?</em></p>
        <div id="stop-think-answer" style="display:none;" class="animate-in"><strong>Answer:</strong> The wave's shape is identical, so the 'wiggle' coefficients (\(a_k\) and \(b_k\)) would stay exactly the same! The only thing that changes is the average value (\(a_0\)). The average would go from 0 to 1. So, \(a_0 = 1\).</div>
        <button class="reveal-button" onclick="revealAnswer('stop-think-answer')">Reveal Answer</button>
    </div>
    <div class="continue-button" onclick="showNextSection(26)">Continue</div>
</section>

<section id="section26">
    <h2>Review and Reflect</h2>
    <p>You just derived one of the most famous results in signal processing. Give yourself a hand‚Äîintegrating products of sines is no small feat!</p>
    
    <p>In this lesson, we:</p>
    <ul>
        <li>Defined a square wave mathematically.</li>
        <li>Used symmetry to determine that \(a_0 = 0\) and all cosine terms \(a_k = 0\) without doing heavy math.</li>
        <li>Calculated the sine terms \(b_k\) and discovered that a square wave is made purely of <strong>odd harmonics</strong> with decreasing amplitudes.</li>
    </ul>
    <p>Now that you've mastered 1D signals, we are ready to level up. In the next lesson, we will take these concepts from squiggly lines to 2D images, which is where Computer Vision really begins.</p>
</section>

<button id="markCompletedBtn" class="mark-completed-button" onclick="toggleCompleted()">‚úì Mark as Completed</button>
</div>

<script>
let currentSection = 1;
const totalSections = 26;

updateProgress();
if (currentSection === totalSections) {
    const completedButton = document.getElementById('markCompletedBtn');
    if (completedButton) completedButton.classList.add('show');
}

function showNextSection(nextSectionId) {
    const nextSectionElement = document.getElementById(`section${nextSectionId}`);
    const currentButton = event && event.target;
    if (!nextSectionElement) return;
    if (currentButton && currentButton.classList.contains('continue-button')) {
        currentButton.style.display = 'none';
    }
    nextSectionElement.classList.add('visible');
    currentSection = nextSectionId;
    updateProgress();
    if (currentSection === totalSections) {
        const completedButton = document.getElementById('markCompletedBtn');
        if (completedButton) completedButton.classList.add('show');
    }
    setTimeout(() => { nextSectionElement.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 200);
}

function updateProgress() {
    const progressBar = document.getElementById('progressBar');
    const progress = (currentSection / totalSections) * 100;
    progressBar.style.width = `${progress}%`;
}

function revealAnswer(id) {
    const revealText = document.getElementById(id);
    const revealButton = event && event.target;
    if (revealText) {
        revealText.style.display = "block";
        revealText.classList.add('animate-in');
    }
    if (revealButton) {
        revealButton.style.display = "none";
    }
}

function selectChoice(element, isCorrect, explanation) {
    const choices = element.parentNode.querySelectorAll('.choice-option');
    choices.forEach(choice => {
        choice.classList.remove('selected', 'correct', 'incorrect');
        const existing = choice.querySelector('.choice-explanation');
        if (existing) existing.remove();
    });
    element.classList.add('selected');
    element.classList.add(isCorrect ? 'correct' : 'incorrect');
    const explanationDiv = document.createElement('div');
    explanationDiv.className = 'choice-explanation';
    explanationDiv.style.display = 'block';
    explanationDiv.innerHTML = `<strong>${isCorrect ? 'Correct!' : 'Not quite.'}</strong> ${explanation}`;
    element.appendChild(explanationDiv);
    
    // Only show continue button if answer is correct
    if (!isCorrect) return;
    
    // Unlock continue button for specific sections
    const parentSection = element.closest('section');
    if (parentSection) {
        // Find if there is a continue button directly following or related to this interaction
        const continueBtn = parentSection.querySelector('.continue-button[style*="display: none"]');
        if (continueBtn && isCorrect) {
             setTimeout(() => {
                continueBtn.style.display = 'block';
                continueBtn.classList.add('show-with-animation');
            }, 800);
        }
    }
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowRight' || e.key === ' ') {
        const btn = document.querySelector(`#section${currentSection} .continue-button`);
        if (btn && btn.style.display !== 'none') {
            e.preventDefault();
            btn.click();
        }
    }
});

document.documentElement.style.scrollBehavior = 'smooth';

function toggleCompleted() {
    const button = document.getElementById('markCompletedBtn');
    if (!button) return;
    const isCompleted = button.classList.contains('completed');
    if (!isCompleted) {
        try {
            if (window.parent && window.parent.ProgressTracker) {
                // Adjust these IDs based on actual LMS structure
                let courseId = 'computer-vision';
                let pathId = 'fourier-transforms'; 
                let moduleId = 'cv-ch2-math-foundations';
                let lessonId = 'cv-ch2-l2-square-wave-deep-dive';
                
                // Fallback to URL params if available
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('course')) courseId = urlParams.get('course');
                if (urlParams.get('path')) pathId = urlParams.get('path');
                if (urlParams.get('module')) moduleId = urlParams.get('module');
                if (urlParams.get('lesson')) lessonId = urlParams.get('lesson');
                
                window.parent.ProgressTracker.markLessonCompleted(courseId, pathId, moduleId, lessonId);
            }
        } catch (error) {
            console.error('Error with ProgressTracker:', error);
        }
        button.classList.add('completed');
        button.innerHTML = '‚úÖ Completed!';
        triggerCelebration();
        localStorage.setItem('lesson_cv-ch2-l2_completed', 'true');
    }
}

function triggerCelebration() {
    createConfetti();
    showSuccessMessage();
}

function createConfetti() {
    const confettiContainer = document.createElement('div');
    confettiContainer.className = 'confetti-container';
    document.body.appendChild(confettiContainer);
    const emojis = ['üéâ', 'üéä', '‚ú®', 'üåü', 'üéà', 'üèÜ', 'üëè', 'ü•≥', 'üåä', 'üìà'];
    const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7'];
    for (let i = 0; i < 40; i++) {
        setTimeout(() => {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            if (Math.random() > 0.6) {
                confetti.textContent = emojis[Math.floor(Math.random() * emojis.length)];
            } else {
                confetti.innerHTML = '‚óè';
                confetti.style.color = colors[Math.floor(Math.random() * colors.length)];
            }
            confetti.style.left = Math.random() * 100 + '%';
            confetti.style.animationDelay = Math.random() * 2 + 's';
            document.querySelector('.confetti-container').appendChild(confetti);
        }, i * 50);
    }
    setTimeout(() => { if (confettiContainer.parentNode) confettiContainer.parentNode.removeChild(confettiContainer); }, 5000);
}

function showSuccessMessage() {
    const successMessage = document.createElement('div');
    successMessage.className = 'success-message';
    successMessage.innerHTML = 'üéâ Lesson Completed! Math Mastered! üéâ';
    document.body.appendChild(successMessage);
    setTimeout(() => { if (successMessage.parentNode) successMessage.parentNode.removeChild(successMessage); }, 2500);
}

window.addEventListener('load', function() {
    const button = document.getElementById('markCompletedBtn');
    if (!button) return;
    const isCompleted = localStorage.getItem('lesson_cv-ch2-l2_completed') === 'true';
    if (isCompleted) {
        button.classList.add('completed');
        button.innerHTML = '‚úÖ Completed!';
    }
});
</script>
</body>
</html>