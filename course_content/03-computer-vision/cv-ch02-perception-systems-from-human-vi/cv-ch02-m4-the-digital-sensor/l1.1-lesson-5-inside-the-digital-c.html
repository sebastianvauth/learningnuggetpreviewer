?<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inside the Digital Camera - The Sensor</title>
    <style>
* {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            color: #2d3748;
            line-height: 1.6;
        }

        /* Progress Bar */
        .progress-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            width: 0%;
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(79, 172, 254, 0.5);
        }



        /* Main Container */
        .lesson-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Section Cards */
        section {
            background: transparent;
            margin-bottom: 30px;
            padding: 20px 0;
            display: none;
            opacity: 0;
            transition: all 0.6s ease;
            transform: translateY(20px);
        }

        section.visible {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        /* Typography */
        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
        }

        h2 {
            font-size: 2rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 1rem;
        }

        p {
            font-size: 1.125rem;
            line-height: 1.7;
            color: #4a5568;
            margin-bottom: 1.5rem;
        }

        ul {
            margin-left: 1.5rem;
            margin-bottom: 1.5rem;
        }

        li {
            font-size: 1.125rem;
            line-height: 1.7;
            color: #4a5568;
            margin-bottom: 0.5rem;
        }

        strong {
            color: #2d3748;
            font-weight: 600;
        }

        em {
            color: #667eea;
            font-style: normal;
            font-weight: 500;
        }

        /* Image Placeholders */
        .image-placeholder {
            margin: 2rem 0;
        }

        /* Confetti Animation */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }

        .confetti {
            position: absolute;
            font-size: 20px;
            animation: confetti-fall 3s linear infinite;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .confetti:nth-child(odd) {
            animation-duration: 2.5s;
            animation-delay: 0.2s;
        }

        .confetti:nth-child(even) {
            animation-duration: 3.5s;
            animation-delay: 0.5s;
        }

        .confetti:nth-child(3n) {
            animation-duration: 2.8s;
            animation-delay: 0.8s;
        }

        .confetti:nth-child(4n) {
            animation-duration: 3.2s;
            animation-delay: 0.3s;
        }

        .confetti:nth-child(5n) {
            animation-duration: 2.7s;
            animation-delay: 0.7s;
        }

        /* Success Message Animation */
        .success-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            font-size: 1.2em;
            font-weight: 600;
            box-shadow: 0 10px 25px rgba(40, 167, 69, 0.3);
            z-index: 10000;
            opacity: 0;
            animation: success-popup 2.5s ease-out;
            pointer-events: none;
        }

        @keyframes success-popup {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            20% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1);
            }
            40% {
                transform: translate(-50%, -50%) scale(1);
            }
            80% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
        }

        .image-placeholder img {
            width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }
        
        /* Specific sizing for individual images by section */
        #section1 .image-placeholder img {
            width: 70% !important;              /* Image 1: 70% (dramatic light beam) */
            max-width: 500px !important;
        }

        #section6 .image-placeholder img {
            width: 55% !important;              /* Image 2: 50-60% (meme image) */
            max-width: 400px !important;
        }
        
        #section9 .image-placeholder img {
            width: 85% !important;              /* Image 3: 80-90% (prism diagram) */
            max-width: 600px !important;
        }
        
        #section13 .image-placeholder img {
            width: 85% !important;              /* Image 4: 80-90% (red object) */
            max-width: 600px !important;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            #section1 .image-placeholder img {
                width: 80% !important;
                max-width: 400px !important;
            }

            #section6 .image-placeholder img {
                width: 65% !important;
                max-width: 350px !important;
            }
            
            #section9 .image-placeholder img,
            #section13 .image-placeholder img {
                width: 90% !important;
                max-width: 450px !important;
            }
        }
        
        @media (max-width: 480px) {
            #section1 .image-placeholder img {
                width: 85% !important;
                max-width: 300px !important;
            }

            #section6 .image-placeholder img {
                width: 75% !important;
                max-width: 280px !important;
            }
            
            #section9 .image-placeholder img,
            #section13 .image-placeholder img {
                width: 95% !important;
                max-width: 320px !important;
            }
        }

        /* Content Boxes */
        .vocab-section, .why-it-matters, .test-your-knowledge, .faq-section, 
        .stop-and-think, .check-your-knowledge {
            margin: 2rem 0;
            padding: 2rem;
            border-radius: 8px;
            border-left: 4px solid;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .vocab-section::before, .why-it-matters::before, .test-your-knowledge::before,
        .faq-section::before, .stop-and-think::before, .check-your-knowledge::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.05;
            z-index: 0;
        }

        .vocab-section {
            background: linear-gradient(135deg, #e6f3ff 0%, #f0f8ff 100%);
            border-left-color: #4facfe;
            box-shadow: 0 10px 30px rgba(79, 172, 254, 0.1);
        }

        .vocab-section::before {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
        }

        .why-it-matters {
            background: linear-gradient(135deg, #ffeef7 0%, #fff0f8 100%);
            border-left-color: #f093fb;
            box-shadow: 0 10px 30px rgba(240, 147, 251, 0.1);
        }

        .why-it-matters::before {
            background: linear-gradient(45deg, #f093fb, #f5576c);
        }

        .test-your-knowledge, .check-your-knowledge {
            background: linear-gradient(135deg, #eafaf1 0%, #f0fcf4 100%);
            border-left-color: #68d391;
            box-shadow: 0 10px 30px rgba(104, 211, 145, 0.1);
        }

        .test-your-knowledge::before, .check-your-knowledge::before {
            background: linear-gradient(45deg, #68d391, #4fd1c7);
        }

        .faq-section {
            background: linear-gradient(135deg, #fffbeb 0%, #fefcf3 100%);
            border-left-color: #fbbf24;
            box-shadow: 0 10px 30px rgba(251, 191, 36, 0.1);
        }

        .faq-section::before {
            background: linear-gradient(45deg, #fbbf24, #f59e0b);
        }

        .stop-and-think {
            background: linear-gradient(135deg, #f3e8ff 0%, #f8f4ff 100%);
            border-left-color: #a78bfa;
            box-shadow: 0 10px 30px rgba(167, 139, 250, 0.1);
        }

        .stop-and-think::before {
            background: linear-gradient(45deg, #a78bfa, #8b5cf6);
        }

        .vocab-section:hover, .why-it-matters:hover, .test-your-knowledge:hover,
        .faq-section:hover, .stop-and-think:hover, .check-your-knowledge:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .vocab-section h3 {
            color: #0ea5e9;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        .why-it-matters h3 {
            color: #ec4899;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        .test-your-knowledge h3, .check-your-knowledge h3 {
            color: #10b981;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        .faq-section h3 {
            color: #d97706;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        .stop-and-think h3 {
            color: #8b5cf6;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        .vocab-section h4, .test-your-knowledge h4, .check-your-knowledge h4, .faq-section h4 {
            color: #2d3748;
            font-size: 1.25rem;
            font-weight: 600;
            margin: 1.5rem 0 1rem 0;
            position: relative;
            z-index: 1;
        }

        .vocab-term {
            color: #0ea5e9;
            font-weight: 600;
        }

        /* Buttons */
        .continue-button, .reveal-button, .check-button {
            display: inline-block;
            padding: 16px 32px;
            margin-top: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50px;
            text-decoration: none;
            cursor: pointer;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .continue-button::before, .reveal-button::before, .check-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .continue-button:hover, .reveal-button:hover, .check-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        .continue-button:hover::before, .reveal-button:hover::before, .check-button:hover::before {
            left: 100%;
        }

        .continue-button:active, .reveal-button:active, .check-button:active {
            transform: translateY(-1px);
        }

        /* Hidden state for conditional buttons */
        .continue-button[style*="display: none"] {
            display: none !important;
        }

        /* Ensure all conditional continue buttons match normal button styling exactly when shown */
        #continue-after-interactive:not([style*="display: none"]),
        #continue-after-check-knowledge:not([style*="display: none"]),
        #continue-after-test-knowledge:not([style*="display: none"]) {
            display: inline-block !important;
            width: auto !important;
            max-width: none !important;
            min-width: auto !important;
            padding: 16px 32px !important;
            margin: 30px auto !important;
            box-sizing: border-box !important;
        }

        /* Center ALL continue buttons by making all sections center them */
        section {
            text-align: center;
        }

        /* Reset text alignment for all content except continue buttons */
        section > *:not(.continue-button) {
            text-align: left;
        }

        /* Ensure content boxes also have left alignment */
        .check-your-knowledge,
        .test-your-knowledge,
        .vocab-section,
        .why-it-matters,
        .faq-section,
        .stop-and-think {
            text-align: left;
        }

        /* Smooth appearance for conditional continue buttons */
        .continue-button.show-with-animation {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.6s ease-out forwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Multiple Choice */
        .multiple-choice {
            margin: 1.5rem 0;
        }

        .choice-option {
            display: block;
            margin: 1rem 0;
            padding: 1.5rem;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .choice-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 0;
        }

        .choice-option:hover {
            transform: translateX(5px);
            border-color: rgba(102, 126, 234, 0.3);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.15);
        }

        .choice-option:hover::before {
            opacity: 0.05;
        }

        .choice-option.selected, .choice-option.correct {
            background: linear-gradient(135deg, #eafaf1 0%, #f0fcf4 100%);
            border-color: #68d391;
            color: #2d3748;
        }

        .choice-option.incorrect {
            background: linear-gradient(135deg, #fef2f2 0%, #fef7f7 100%);
            border-color: #f87171;
            color: #2d3748;
        }

        .choice-explanation {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: #f1f5f9;
            border-radius: 8px;
            font-size: 0.9rem;
            line-height: 1.6;
            animation: fadeIn 0.5s ease;
            position: relative;
            z-index: 1;
        }

        /* Spectrum Explorer - keeping the interactive styles but updating colors */
        .spectrum-explorer {
            position: relative;
            width: 100%;
            max-width: 100%;
            margin: 2rem 0;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            padding: 40px;
        }

        .stage {
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .stage-text h3 {
            font-size: 1.75rem;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0 0 16px 0;
        }

        .instruction {
            font-size: 1.1rem;
            color: #6b7280;
            margin: 0;
            padding: 16px 24px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            border: 2px dashed rgba(102, 126, 234, 0.3);
        }

        .continue-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .continue-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        .revelation-text h3 {
            font-size: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0 0 16px 0;
        }

        .spectrum-point {
            border-radius: 16px;
            transition: all 0.3s ease;
            border: 2px solid #e2e8f0;
            background: #ffffff;
        }

        .spectrum-point:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.2);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .spectrum-point.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        .info-panel {
            background: #ffffff;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 24px;
        }

        .region-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hook {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .lesson-container {
                padding: 20px 15px;
            }

            section {
                padding: 15px 0;
                margin-bottom: 20px;
            }

            h1 {
                font-size: 2rem;
            }

            h2 {
                font-size: 1.75rem;
            }

            p, li {
                font-size: 1rem;
            }



            .continue-button, .reveal-button, .check-button {
                width: 100%;
            text-align: center;
                margin-top: 1.5rem;
            }

            .spectrum-explorer {
                padding: 20px;
            }

            .choice-option {
                padding: 1rem;
            }

            .mark-completed-button {
                padding: 14px 28px;
                font-size: 0.9rem;
                margin: 30px auto 15px auto;
            }
        }

        @media (max-width: 480px) {
            .lesson-container {
                padding: 15px 10px;
            }

            section {
                padding: 10px 0;
            }

            h1 {
                font-size: 1.75rem;
            }

            .vocab-section, .why-it-matters, .test-your-knowledge, 
            .faq-section, .stop-and-think, .check-your-knowledge {
                padding: 1.5rem;
            }

            .mark-completed-button {
                padding: 12px 24px;
                font-size: 0.85rem;
                margin: 25px auto 10px auto;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: fadeIn 0.5s ease-out;
        }

        /* Accessibility */
        .choice-option:focus {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }

        .continue-button:focus, .reveal-button:focus, .check-button:focus {
            outline: 2px solid white;
            outline-offset: 2px;
        }

        /* Content positioning */
        .vocab-section *, .why-it-matters *, .test-your-knowledge *, 
        .faq-section *, .stop-and-think *, .check-your-knowledge * {
            position: relative;
            z-index: 1;
        }

        /* Mark as Completed Button */
        .mark-completed-button {
            display: none;
            width: 100%;
            max-width: 400px;
            margin: 40px auto 20px auto;
            padding: 16px 32px;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(72, 187, 120, 0.3);
            text-align: center;
            text-decoration: none;
        }

        .mark-completed-button.show {
            display: block;
        }

        .mark-completed-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(72, 187, 120, 0.4);
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
        }

        .mark-completed-button:active {
            transform: translateY(0);
        }

        .mark-completed-button.completed {
            background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
            box-shadow: 0 4px 20px rgba(148, 163, 184, 0.3);
            cursor: default;
        }

        .mark-completed-button.completed:hover {
            background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
            box-shadow: 0 4px 20px rgba(148, 163, 184, 0.3);
            transform: none;
        }

        /* Success Message */
        .lesson-success-message {
            text-align: center;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            margin: 20px auto;
            max-width: 300px;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
        }

        .lesson-success-message.show {
            opacity: 1;
            transform: translateY(0);
        }



        /* Spectrum Explorer specific modern styles */
        .spectrum-explorer {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }

        .prism-svg {
            cursor: pointer;
            user-select: none;
            margin-bottom: 24px;
            filter: drop-shadow(0 10px 30px rgba(0,0,0,0.1));
            border-radius: 12px;
        }

        .visible-indicator {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 2px solid #667eea;
            color: #667eea;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        }

        .scale-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }

        .scale-label.visible {
            color: #667eea;
            font-weight: 600;
        }

        .exploration-progress {
            text-align: center;
            margin-top: 20px;
            padding: 16px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .progress-text {
            font-size: 0.875rem;
            color: #667eea;
            font-weight: 600;
        }



        /* Keep all other spectrum explorer functionality styles */
        .spectrum-bar {
            position: relative;
            width: 100%;
            height: 60px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        #spectrum-canvas {
            width: 100%;
            height: 100%;
            border-radius: 12px;
        }

        .spectrum-points {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0 0 24px 0;
            gap: 8px;
        }

        .spectrum-point {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 12px 8px;
            cursor: pointer;
            min-width: 80px;
            outline: none;
        }

        .point-icon {
            font-size: 1.5rem;
        }
        
        .point-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
        }

        .energy-scale {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .energy-label {
            font-size: 0.875rem;
            color: #6b7280;
            white-space: nowrap;
            font-weight: 500;
        }

        .energy-bar {
            flex: 1;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .energy-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #f59e0b 50%, #ef4444 100%);
            transition: width 0.5s ease;
            border-radius: 4px;
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .panel-header .region-icon {
            color: initial !important;
            background: none !important;
            -webkit-text-fill-color: initial !important;
            background-clip: initial !important;
        }
        
        /* Fix emoji colors in revelation text and all spectrum content */
        .revelation-text h3,
        .revelation-text,
        .spectrum-point .point-icon,
        h3 {
            color: inherit;
        }
        
        /* Target emojis specifically to prevent color inheritance */
        .revelation-text h3::after,
        .revelation-text h3 *,
        .spectrum-point .point-icon,
        .point-icon {
            background: none !important;
            -webkit-background-clip: initial !important;
            -webkit-text-fill-color: initial !important;
            background-clip: initial !important;
            color: initial !important;
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif !important;
        }
        
        /* Specific fix for Mind = Blown emoji */
        .revelation-text h3 {
            background: none !important;
            -webkit-background-clip: initial !important;
            -webkit-text-fill-color: initial !important;
            background-clip: initial !important;
        }
        
        /* Universal emoji fix */
        span[style*="color: initial"],
        .emoji-fix {
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", "Segoe UI Symbol", sans-serif !important;
            font-style: normal !important;
            font-variant: normal !important;
            text-rendering: auto !important;
            -webkit-font-smoothing: auto !important;
        }
        
        /* Additional emoji protection */
        .revelation-text span,
        .spectrum-point .point-icon {
            display: inline !important;
            text-decoration: none !important;
            font-weight: normal !important;
        }

        .region-icon {
            font-size: 2rem;
            color: initial;
            text-shadow: none;
            filter: none;
            display: inline-block;
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
        }

        .story-content {
            margin-bottom: 24px;
        }

        .description {
            font-size: 1rem;
            line-height: 1.6;
            margin: 0;
            color: #6b7280;
        }

        .tech-specs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .spec-item {
            text-align: center;
            padding: 12px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .spec-label {
            display: block;
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 4px;
            letter-spacing: 0.05em;
        }

        .spec-value {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
        }

        .color-display {
            margin-top: 16px;
        }

        .color-swatch {
            height: 40px;
            border-radius: 12px;
            margin-bottom: 8px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .color-note {
            font-size: 0.875rem;
            color: #6b7280;
            margin: 0;
            font-style: italic;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Responsive design for spectrum explorer */
        @media (min-width: 768px) {
            .exploration-container {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 32px;
                align-items: start;
            }
            
            .spectrum-points {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .spectrum-point {
                min-width: 100px;
            }
        }

        @media (max-width: 480px) {
            .spectrum-explorer {
                padding: 20px;
            }
            
            .spectrum-points {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 12px;
            }
            
            .spectrum-point {
                min-width: auto;
            }
            
            .point-label {
                font-size: 0.7rem;
            }
            
            .tech-specs {
                grid-template-columns: 1fr;
            }
        }
</style>
</head>
<body>
    <!-- Progress Bar -->
    <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <div class="lesson-container">
        <section id="section1" class="visible">
            <div class="image-placeholder">
                <img src="images/l24_1.png" alt="...">
        </div>
            <h1>Inside the Digital Camera: The Sensor</h1>
            <p>We've formed a sharp image with a lens. But in a digital camera, there's no film. So how do we <em>record</em> that image and turn it into a file on a memory card? It's time to meet the digital equivalent of the retina: the image sensor. This tiny silicon chip is where light finally becomes data.</p>
            <div class="continue-button" onclick="showNextSection(2)">Continue</div>
        </section>

        <section id="section2">
            <h2>From Light to Electricity</h2>
            <p>At the heart of every image sensor is a grid of millions of microscopic light detectors called <strong>photodiodes</strong>. Think of each photodiode as a single pixel on the final image.</p>
            <div class="continue-button" onclick="showNextSection(3)">Continue</div>
        </section>

        <section id="section3">
            <p>A photodiode has a very simple and amazing job: when a photon of light strikes it, it generates a tiny electrical charge. The more photons that hit it (i.e., the brighter the light), the stronger the electrical charge it produces. It's a direct conversion of light energy into electrical energy.</p>
            <div class="image-placeholder">
                <img src="images/l24_2.png" alt="...">
        </div>
            <div class="continue-button" onclick="showNextSection(4)">Continue</div>
        </section>

        <section id="section4">
            <p>So now we have a grid of millions of tiny electrical charges, each one corresponding to the brightness of a specific point in our scene. But there's a problem... these photodiodes are colorblind. They only measure intensity, not color.</p>
            <div class="continue-button" onclick="showNextSection(5)">Continue</div>
        </section>

        <section id="section5">
            <h2>The Bayer Filter: Giving the Sensor Color Vision</h2>
            <p>How do we get a color image from a colorblind sensor? We use a clever trick, inspired by the human eye! We place a microscopic mosaic of color filters over the grid of photodiodes. This mosaic is called a <strong>Bayer Filter</strong>.</p>
            <div class="continue-button" onclick="showNextSection(6)">Continue</div>
        </section>

        <section id="section6">
            <p>The filter consists of a repeating 2x2 pattern of Red, Green, Green, and Blue filters (RGGB). Each tiny filter only allows light of its own color to pass through to the photodiode beneath it.</p>
            <div class="bayer-challenge hint-hidden" id="bayerChallenge" aria-labelledby="bayerHeading">
                <h4 id="bayerHeading" style="margin-bottom: 0.5rem; color: #2d3748;">The Bayer Filter Challenge</h4>
                <p class="bayer-instructions">Place the color filters to form the RGGB pattern across the 4?4 grid. Select a color then click a cell. Only correct placements are accepted.</p>
                <div class="bayer-controls">
                    <button class="palette-tile" id="paletteR" data-color="R" aria-pressed="false" aria-label="Select Red filter">
                        <span class="palette-swatch swatch-R" aria-hidden="true"></span>
                        R
                        <span class="count" id="countR">4</span>
                    </button>
                    <button class="palette-tile" id="paletteG" data-color="G" aria-pressed="false" aria-label="Select Green filter">
                        <span class="palette-swatch swatch-G" aria-hidden="true"></span>
                        G
                        <span class="count" id="countG">8</span>
                    </button>
                    <button class="palette-tile" id="paletteB" data-color="B" aria-pressed="false" aria-label="Select Blue filter">
                        <span class="palette-swatch swatch-B" aria-hidden="true"></span>
                        B
                        <span class="count" id="countB">4</span>
                    </button>
                    <button class="hint-toggle" id="hintToggle" aria-expanded="false">Show Hint</button>
                    <button class="reset-button" id="resetBayer">Reset</button>
                </div>
                <div class="bayer-grid" id="bayerGrid" role="grid" aria-label="Bayer grid">
                    <div class="bayer-cell" role="gridcell" tabindex="0" data-row="0" data-col="0"><span class="hint-letter">R</span></div>
                    <div class="bayer-cell" role="gridcell" tabindex="0" data-row="0" data-col="1"><span class="hint-letter">G</span></div>
                    <div class="bayer-cell" role="gridcell" tabindex="0" data-row="0" data-col="2"><span class="hint-letter">R</span></div>
                    <div class="bayer-cell" role="gridcell" tabindex="0" data-row="0" data-col="3"><span class="hint-letter">G</span></div>

                    <div class="bayer-cell" role="gridcell" tabindex="0" data-row="1" data-col="0"><span class="hint-letter">G</span></div>
                    <div class="bayer-cell" role="gridcell" tabindex="0" data-row="1" data-col="1"><span class="hint-letter">B</span></div>
                    <div class="bayer-cell" role="gridcell" tabindex="0" data-row="1" data-col="2"><span class="hint-letter">G</span></div>
                    <div class="bayer-cell" role="gridcell" tabindex="0" data-row="1" data-col="3"><span class="hint-letter">B</span></div>

                    <div class="bayer-cell" role="gridcell" tabindex="0" data-row="2" data-col="0"><span class="hint-letter">R</span></div>
                    <div class="bayer-cell" role="gridcell" tabindex="0" data-row="2" data-col="1"><span class="hint-letter">G</span></div>
                    <div class="bayer-cell" role="gridcell" tabindex="0" data-row="2" data-col="2"><span class="hint-letter">R</span></div>
                    <div class="bayer-cell" role="gridcell" tabindex="0" data-row="2" data-col="3"><span class="hint-letter">G</span></div>

                    <div class="bayer-cell" role="gridcell" tabindex="0" data-row="3" data-col="0"><span class="hint-letter">G</span></div>
                    <div class="bayer-cell" role="gridcell" tabindex="0" data-row="3" data-col="1"><span class="hint-letter">B</span></div>
                    <div class="bayer-cell" role="gridcell" tabindex="0" data-row="3" data-col="2"><span class="hint-letter">G</span></div>
                    <div class="bayer-cell" role="gridcell" tabindex="0" data-row="3" data-col="3"><span class="hint-letter">B</span></div>
                </div>
                <div id="bayerAriaLive" class="sr-only" aria-live="polite"></div>
                <div class="bayer-footer">Notice there are twice as many <strong>G</strong> as <strong>R</strong> or <strong>B</strong>.</div>
                <div class="continue-button" id="start-quiz-after-interactive" style="display: none;">Start Quiz</div>
            </div>
            <div class="check-your-knowledge" id="section6-quiz" style="display: none;">
                <h3>Check Your Knowledge</h3>
                <h4>After light has passed through the Bayer filter, how many color values have been directly measured at a single pixel's location?</h4>
                <div class="multiple-choice">
                    <div class="choice-option" onclick="selectChoice(this, false, 'Three (R, G, and B)', 'Not quite. This is the goal for the final image, but at this stage, each individual photodiode has only seen light of one color.')">
                        Three (R, G, and B)
                    </div>
                    <div class="choice-option" onclick="selectChoice(this, true, 'Only one (either R, or G, or B)', 'Exactly! A pixel under a red filter only knows the intensity of red light. A pixel under a green filter only knows the intensity of green light, and so on.')">
                        Only one (either R, or G, or B)
                    </div>
                    <div class="choice-option" onclick="selectChoice(this, false, 'None, the color is measured later.', 'The color information *is* being measured here, but it\'s incomplete. Each pixel gets one piece of the color puzzle.')">
                        None, the color is measured later.
                    </div>
                </div>
            </div>
            <div class="continue-button" id="continue-after-check-knowledge" onclick="showNextSection(7)" style="display: none;">Continue</div>
        </section>

        <section id="section7">
            <div class="stop-and-think">
                <h3>Stop and Think</h3>
                <h4>If each pixel only measures one color (R, G, or B), how can the final image we see have full RGB color for every single pixel? What must the camera's software do to fill in the blanks?</h4>
                <button class="reveal-button" onclick="revealAnswer('demosaicing-answer')">Reveal Answer</button>
                <div id="demosaicing-answer" class="choice-explanation" style="display: none;">
                    <strong>Here's the answer:</strong> It has to make an educated guess! For a pixel that measured red, the camera's processor looks at its immediate neighbors. It 'borrows' the green value from its green neighbors and the blue value from its blue neighbors. This process of intelligently interpolating the missing colors is called 'Demosaicing', and we'll cover it in the final lesson of this chapter!
                </div>
            </div>
            <div class="continue-button" onclick="showNextSection(8)">Continue</div>
        </section>

        <section id="section8">
            <h2>The Two Titans: CCD vs. CMOS</h2>
            <p>Finally, how does the camera read the electrical charge from these millions of photodiodes? There are two main technologies that have dominated the industry, like two rival titans: CCD and CMOS.</p>
            <div class="image-placeholder">
                [Image Placeholder: A meme comparing CCD and CMOS sensors. On the left, a picture of a wise, old, master artisan carefully crafting something beautiful, labeled 'CCD: Flawless Quality, Takes Its Time'. On the right, a picture of a hyper-efficient, multi-tasking modern factory robot, labeled 'CMOS: Fast, Cheap, and In Everything You Own'.]
            </div>
            <div class="continue-button" onclick="showNextSection(9)">Continue</div>
        </section>

        <section id="section9">
            <div class="sensor-comparison">
                <div class="sensor-type ccd-sensor">
                    <div class="sensor-title">CCD (Charge-Coupled Device)</div>
                    <p>The old master. In a CCD, the charge from each pixel is passed down the line, pixel by pixel, like a bucket brigade, to a single, high-quality converter at the end. This process is slow but results in very high-quality, low-noise images. They are found in high-end scientific and astronomical cameras.</p>
                    <div class="image-placeholder" style="margin: 1rem 0;">
                        [Image Placeholder: An animation of a CCD sensor readout (based on Figure 2.15). It shows a grid of pixels, each with a colored water droplet inside. An animation shows the droplets being shifted row by row onto a conveyor belt, which then carries them one by one to a 'measuring station' at the end.]
                    </div>
                </div>

                <div class="sensor-type cmos-sensor">
                    <div class="sensor-title">CMOS (Complementary Metal-Oxide-Semiconductor)</div>
                    <p>The modern workhorse. In a CMOS sensor, each pixel has its own amplifier to convert charge to voltage right at the pixel site. This allows the camera to read out all the pixels much faster, often row by row. They are cheaper to make, use less power, and are fast enough for high-frame-rate video. This is the technology inside your smartphone, webcam, and most consumer cameras today.</p>
                    <div class="image-placeholder" style="margin: 1rem 0;">
                        [Image Placeholder: An animation of a CMOS sensor readout (based on Figure 2.16). It shows a grid of pixels, and instead of a conveyor belt, each row lights up sequentially as data is read from it in parallel. The process is visibly much faster than the CCD animation.]
                    </div>
                </div>
            </div>

            <div class="why-it-matters">
                <h3>Why It Matters</h3>
                <p>Understanding the difference between CCD and CMOS explains why different cameras have different strengths. The choice of sensor technology directly impacts a camera's cost, speed, low-light performance, and suitability for tasks like high-speed video versus long-exposure astrophotography.</p>
            </div>
            <div class="vocab-section">
                <h3>Build Your Vocab</h3>
                <h4 class="vocab-term">Photodiode</h4>
                <p>A semiconductor device that converts light (photons) into a proportional electrical signal. The building block of an image sensor.</p>
                <h4 class="vocab-term">Bayer Filter</h4>
                <p>A mosaic of Red, Green, and Blue filters (RGGB) placed over a sensor to allow it to capture color information.</p>
                <h4 class="vocab-term">CMOS Sensor</h4>
                <p>The dominant sensor technology today. It is fast, power-efficient, and reads data in parallel, making it ideal for video and consumer devices.</p>
            </div>
            <div class="continue-button" onclick="showNextSection(10)">Continue</div>
        </section>

        <section id="section10">
            <div class="faq-section">
                <h3>Frequently Asked Questions</h3>
                <h4>If CMOS is so much better, why would anyone still use a CCD?</h4>
                <p>For a long time, CCDs had a significant advantage in image quality, especially in low-noise and light sensitivity. While modern CMOS sensors have largely closed that gap, for certain very high-precision scientific applications where absolute image fidelity is more important than speed or cost, a specialized CCD can still be the superior choice.</p>
            </div>
            <div class="continue-button" onclick="showNextSection(11)">Continue</div>
        </section>

        <section id="section11">
            <div class="test-your-knowledge">
                <h3>Test Your Knowledge</h3>
                <h4>You're designing a cheap, high-speed webcam that needs to capture smooth video. Which sensor technology would be the obvious choice?</h4>
                <div class="multiple-choice">
                    <div class="choice-option" onclick="selectChoice(this, false, 'CCD, because of its superior image quality.', 'While the quality is great, CCDs are generally too slow and expensive for a product like a webcam, especially one that needs high-speed video.')">
                        CCD, because of its superior image quality.
                    </div>
                    <div class="choice-option" onclick="selectChoice(this, true, 'CMOS, because it\'s fast, power-efficient, and inexpensive.', 'Absolutely. CMOS technology\'s speed (from parallel readout) and low manufacturing cost make it the perfect fit for webcams, smartphones, and most video applications.')">
                        CMOS, because it's fast, power-efficient, and inexpensive.
                    </div>
                    <div class="choice-option" onclick="selectChoice(this, false, 'A Bayer Filter, because it\'s needed for color.', 'A Bayer filter is a component you\'d put on top of the sensor, not the sensor technology itself. Both a CCD and a CMOS sensor would need one to see color.')">
                        A Bayer Filter, because it's needed for color.
                    </div>
                </div>
            </div>
            <div class="continue-button" id="continue-after-test-knowledge" onclick="showNextSection(12)" style="display: none;">Continue</div>
        </section>

        <section id="section12">
            <h2>Review and Reflect</h2>

            <p>We've gone deep inside the digital camera! This is where light officially becomes an electronic signal. Let's review the key components:</p>
            <ul>
                <li><strong>Photodiodes:</strong> Millions of microscopic detectors that convert light intensity into an electrical charge.</li>
                <li><strong>Bayer Filter:</strong> A clever RGGB filter pattern that sits on top of the colorblind sensor, allowing it to capture color data by measuring only one color at each pixel.</li>
                <li><strong>CCD vs. CMOS:</strong> Two rival sensor technologies. CCDs are slow and high-quality, while CMOS sensors are fast, cheap, and dominate the modern market.</li>
            </ul>
            <p>But the speed of a CMOS sensor comes with a strange side effect that can warp reality. In the next lesson, we'll explore the weird world of the rolling shutter.</p>
            
        </section>

        <!-- Mark as Completed Button -->
        <button id="markCompletedBtn" class="mark-completed-button" onclick="toggleCompleted()"> &#10003; Mark as Completed
        </button>

    </div>

    <script>
        let currentSection = 1;
        const totalSections = 12;

        // Initialize
        updateProgress();

        // Show the mark as completed button if already on the final section
        if (currentSection === totalSections) {
            const completedButton = document.getElementById('markCompletedBtn');
            if (completedButton) {
                completedButton.classList.add('show');
            }
        }

        function showNextSection(nextSectionId) {
            const currentSectionElement = document.getElementById(`section${currentSection}`);
            const nextSectionElement = document.getElementById(`section${nextSectionId}`);
            const currentButton = event.target;

            if (!nextSectionElement) return;

            // Hide the continue button
            currentButton.style.display = 'none';

            // Show next section with smooth animation
            nextSectionElement.classList.add('visible', 'animate-in');

            // Update current section
            currentSection = nextSectionId;
            updateProgress();

            // Show the mark as completed button when reaching the final section
            if (currentSection === totalSections) {
                const completedButton = document.getElementById('markCompletedBtn');
                if (completedButton) {
                    completedButton.classList.add('show');
                }
            }

            // Smooth scroll to new section
            setTimeout(() => {
                nextSectionElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }, 300);
        }

        function updateProgress() {
            const progressBar = document.getElementById('progressBar');
            const progress = (currentSection / totalSections) * 100;
            progressBar.style.width = `${progress}%`;
        }

        function revealAnswer(id) {
            const revealText = document.getElementById(id);
            const revealButton = event.target;

            if (revealText && revealButton) {
                revealText.style.display = "block";
                revealText.classList.add('animate-in');
                revealButton.style.display = "none";
            }
        }

        function selectChoice(element, isCorrect, optionText, explanation) {
            // Remove previous selections
            const choices = element.parentNode.querySelectorAll('.choice-option');
            choices.forEach(choice => {
                choice.classList.remove('selected', 'correct', 'incorrect');
                const existingExplanation = choice.querySelector('.choice-explanation');
                if (existingExplanation) {
                    existingExplanation.remove();
                }
            });

            // Mark the selected choice
            element.classList.add('selected');
            element.classList.add(isCorrect ? 'correct' : 'incorrect');

            // Add explanation with animation
            const explanationDiv = document.createElement('div');
            explanationDiv.className = 'choice-explanation animate-in';
            explanationDiv.style.display = 'block';
            explanationDiv.innerHTML = `<strong>${isCorrect ? 'Correct!' : 'Not quite.'}</strong> ${explanation}`;
            element.appendChild(explanationDiv);

            // Show correct answer if wrong choice was selected
            if (!isCorrect) {
                choices.forEach(choice => {
                    if (choice !== element) {
                        const choiceText = choice.textContent.trim();
                        if (choiceText.includes('Only one') || choiceText.includes('CMOS, because it\'s fast')) {
                            choice.classList.add('correct');
                            const correctExplanation = document.createElement('div');
                            correctExplanation.className = 'choice-explanation animate-in';
                            correctExplanation.style.display = 'block';
                            if (choiceText.includes('Only one')) {
                                correctExplanation.innerHTML = '<strong>This is the correct answer:</strong> Exactly! A pixel under a red filter only knows the intensity of red light. A pixel under a green filter only knows the intensity of green light, and so on.';
                            } else if (choiceText.includes('CMOS, because it\'s fast')) {
                                correctExplanation.innerHTML = '<strong>This is the correct answer:</strong> Absolutely. CMOS technology\'s speed (from parallel readout) and low manufacturing cost make it the perfect fit for webcams, smartphones, and most video applications.';
                            }
                            choice.appendChild(correctExplanation);
                        }
                    }
                });
            }

            // Show continue button after answering
            const parentSection = element.closest('section');
            if (parentSection) {
                const sectionId = parentSection.id;
                let continueButtonId = null;

                if (sectionId === 'section6') {
                    continueButtonId = 'continue-after-check-knowledge';
                } else if (sectionId === 'section11') {
                    continueButtonId = 'continue-after-test-knowledge';
                }

                if (continueButtonId) {
                    const continueButton = document.getElementById(continueButtonId);
                    if (continueButton && continueButton.style.display === 'none') {
                        setTimeout(() => {
                            continueButton.style.display = 'block';
                            continueButton.classList.add('show-with-animation');
                        }, 1000);
                    }
                }
            }
        }

        // Keyboard Support
        document.addEventListener('keydown', function(event) {
            if (event.key === 'ArrowRight' || event.key === ' ') {
                const continueButton = document.querySelector(`#section${currentSection} .continue-button`);
                if (continueButton && continueButton.style.display !== 'none') {
                    event.preventDefault();
                    continueButton.click();
                }
            }
        });

        // Smooth scrolling
        document.documentElement.style.scrollBehavior = 'smooth';

        // Mark as Completed functionality
        function toggleCompleted() {
            const button = document.getElementById('markCompletedBtn');
            if (!button) return;

            const isCompleted = button.classList.contains('completed');

            if (!isCompleted) {
                // Try to use platform's ProgressTracker system
                try {
                    if (window.parent && window.parent.ProgressTracker) {
                        let courseId = 'computer-vision';
                        let pathId = 'perception-systems';
                        let moduleId = 'cv-digital-sensor';
                        let lessonId = 'cv-l5-digital-sensor';

                        if (window.parent.currentRoute) {
                            const route = window.parent.currentRoute;
                            if (route.courseId) courseId = route.courseId;
                            if (route.pathId) pathId = route.pathId;
                            if (route.moduleId) moduleId = route.moduleId;
                            if (route.lessonId) lessonId = route.lessonId;
                        }

                        const urlParams = new URLSearchParams(window.location.search);
                        if (urlParams.get('course')) courseId = urlParams.get('course');
                        if (urlParams.get('path')) pathId = urlParams.get('path');
                        if (urlParams.get('module')) moduleId = urlParams.get('module');
                        if (urlParams.get('lesson')) lessonId = urlParams.get('lesson');

                        window.parent.ProgressTracker.markLessonCompleted(courseId, pathId, moduleId, lessonId);
                    }
                } catch (error) {
                    console.error('Error with ProgressTracker:', error);
                }

                // Update button appearance
                button.classList.add('completed');
                button.innerHTML = '&#9989; Completed!';

                // Trigger celebration
                triggerCelebration();

                // Fallback localStorage for direct access
                localStorage.setItem('lesson_cv-ch02-l5_completed', 'true');
            }
        }

        function triggerCelebration() {
            // Create confetti
            createConfetti();

            // Show success message
            showSuccessMessage();
        }

        function createConfetti() {
            const confettiContainer = document.createElement('div');
            confettiContainer.className = 'confetti-container';
            document.body.appendChild(confettiContainer);

            const confettiEmojis = ['??', '??', '?', '??', '??', '??', '??', '??', '??', '??'];
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#dda0dd', '#98d8c8', '#f7dc6f'];

            // Create 50 confetti pieces
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';

                    // Random emoji or colored shape
                    if (Math.random() > 0.6) {
                        confetti.textContent = confettiEmojis[Math.floor(Math.random() * confettiEmojis.length)];
                    } else {
                        confetti.innerHTML = '?';
                        confetti.style.color = colors[Math.floor(Math.random() * colors.length)];
                    }

                    // Random horizontal position
                    confetti.style.left = Math.random() * 100 + '%';

                    // Random animation delay
                    confetti.style.animationDelay = Math.random() * 2 + 's';

                    confettiContainer.appendChild(confetti);
                }, i * 50);
            }

            // Remove confetti after animation
            setTimeout(() => {
                if (confettiContainer.parentNode) {
                    confettiContainer.parentNode.removeChild(confettiContainer);
                }
            }, 5000);
        }

        function showSuccessMessage() {
            const successMessage = document.createElement('div');
            successMessage.className = 'success-message';
            successMessage.innerHTML = '?? Lesson Completed! Great Job! ??';
            document.body.appendChild(successMessage);

            // Remove success message after animation
            setTimeout(() => {
                if (successMessage.parentNode) {
                    successMessage.parentNode.removeChild(successMessage);
                }
            }, 2500);
        }

        // Load completion status on page load
        window.addEventListener('load', function() {
            const button = document.getElementById('markCompletedBtn');
            if (!button) return;

            // Check platform ProgressTracker first
            if (window.parent && window.parent.ProgressTracker) {
                let courseId = 'computer-vision';
                let pathId = 'perception-systems';
                let moduleId = 'cv-digital-sensor';
                let lessonId = 'cv-l5-digital-sensor';

                if (window.parent.currentRoute) {
                    const route = window.parent.currentRoute;
                    if (route.courseId) courseId = route.courseId;
                    if (route.pathId) pathId = route.pathId;
                    if (route.moduleId) moduleId = route.moduleId;
                    if (route.lessonId) lessonId = route.lessonId;
                }

                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('course')) courseId = urlParams.get('course');
                if (urlParams.get('path')) pathId = urlParams.get('path');
                if (urlParams.get('module')) moduleId = urlParams.get('module');
                if (urlParams.get('lesson')) lessonId = urlParams.get('lesson');

                const progress = window.parent.ProgressTracker.getLessonProgress(courseId, pathId, moduleId, lessonId);

                if (progress.state === window.parent.ProgressTracker.STATES.COMPLETED) {
                    button.classList.add('completed');
                    button.innerHTML = '&#9989; Completed!';
                    return;
                }
            }

            // Fallback to localStorage
            const isCompleted = localStorage.getItem('lesson_cv-ch02-l5_completed') === 'true';
            if (isCompleted) {
                button.classList.add('completed');
                button.innerHTML = '&#9989; Completed!';
            }
        });

        // Bayer Filter Challenge logic
        (function initBayerChallenge() {
            const challenge = document.getElementById('bayerChallenge');
            if (!challenge) return;

            const grid = document.getElementById('bayerGrid');
            const quizBlock = document.getElementById('section6-quiz');
            const startQuizBtn = document.getElementById('start-quiz-after-interactive');
            const ariaLive = document.getElementById('bayerAriaLive');
            const hintToggle = document.getElementById('hintToggle');
            const resetBtn = document.getElementById('resetBayer');
            const paletteButtons = [
                document.getElementById('paletteR'),
                document.getElementById('paletteG'),
                document.getElementById('paletteB')
            ];

            let selectedColor = null; // 'R' | 'G' | 'B' | null
            const requiredAt = (row, col) => {
                // RGGB pattern tiled
                const isRowEven = row % 2 === 0;
                const isColEven = col % 2 === 0;
                if (isRowEven && isColEven) return 'R';
                if (isRowEven && !isColEven) return 'G';
                if (!isRowEven && isColEven) return 'G';
                return 'B';
            };

            const remaining = { R: 4, G: 8, B: 4 };
            const gridState = Array.from({ length: 4 }, () => Array(4).fill(null));

            function updatePaletteUI() {
                const countR = document.getElementById('countR');
                const countG = document.getElementById('countG');
                const countB = document.getElementById('countB');
                if (countR) countR.textContent = String(remaining.R);
                if (countG) countG.textContent = String(remaining.G);
                if (countB) countB.textContent = String(remaining.B);
                paletteButtons.forEach(btn => {
                    if (!btn) return;
                    const color = btn.getAttribute('data-color');
                    const isSelected = selectedColor === color;
                    btn.classList.toggle('selected', isSelected);
                    btn.setAttribute('aria-pressed', String(isSelected));
                    btn.disabled = remaining[color] === 0 && !isSelected;
                });
            }

            function speak(msg) {
                if (ariaLive) ariaLive.textContent = msg;
            }

            function clearCellUI(cell) {
                cell.classList.remove('placed', 'placed-R', 'placed-G', 'placed-B', 'invalid');
                cell.removeAttribute('data-color');
                const hint = cell.querySelector('.hint-letter');
                if (hint) hint.style.visibility = '';
            }

            function placeAt(cell, row, col, color) {
                const req = requiredAt(row, col);
                if (gridState[row][col]) {
                    // Toggle remove if same cell already has a placement
                    const existing = gridState[row][col];
                    gridState[row][col] = null;
                    remaining[existing] += 1;
                    clearCellUI(cell);
                    updatePaletteUI();
                    speak(`${existing} removed at row ${row + 1}, column ${col + 1}`);
                    return true;
                }

                if (color !== req) {
                    cell.classList.add('invalid');
                    const needed = req === 'R' ? 'Red' : req === 'G' ? 'Green' : 'Blue';
                    speak(`That cell needs ${needed}`);
                    setTimeout(() => cell.classList.remove('invalid'), 300);
                    return false;
                }

                if (remaining[color] <= 0) {
                    speak(`${color} tiles are all used`);
                    return false;
                }

                gridState[row][col] = color;
                remaining[color] -= 1;
                cell.classList.add('placed', `placed-${color}`);
                cell.setAttribute('data-color', color);
                const hint = cell.querySelector('.hint-letter');
                if (hint) hint.style.visibility = 'hidden';
                speak(`${color} placed at row ${row + 1}, column ${col + 1}`);
                updatePaletteUI();
                checkCompletion();
                return true;
            }

            function resetAll(confirmIfFilled = true) {
                const filled = gridState.flat().some(Boolean);
                if (confirmIfFilled && filled && !window.confirm('Reset the grid? Your placements will be cleared.')) {
                    return;
                }
                for (let r = 0; r < 4; r++) {
                    for (let c = 0; c < 4; c++) {
                        gridState[r][c] = null;
                    }
                }
                remaining.R = 4; remaining.G = 8; remaining.B = 4;
                Array.from(grid.querySelectorAll('.bayer-cell')).forEach(clearCellUI);
                selectedColor = null;
                updatePaletteUI();
                speak('Grid reset');
            }

            function checkCompletion() {
                const allFilled = gridState.flat().every(Boolean);
                if (!allFilled) return;
                // Completed successfully because only correct placements are accepted
                speak('Success! Bayer pattern completed');
                if (startQuizBtn && startQuizBtn.style.display === 'none') {
                    startQuizBtn.style.display = 'inline-block';
                    startQuizBtn.classList.add('show-with-animation');
                }
            }

            // Event listeners
            paletteButtons.forEach(btn => {
                if (!btn) return;
                btn.addEventListener('click', function() {
                    const color = this.getAttribute('data-color');
                    selectedColor = (selectedColor === color) ? null : color;
                    updatePaletteUI();
                    if (selectedColor) {
                        const colorName = selectedColor === 'R' ? 'Red' : selectedColor === 'G' ? 'Green' : 'Blue';
                        speak(`${colorName} selected`);
                    } else {
                        speak('No color selected');
                    }
                });
            });

            grid.addEventListener('click', function(e) {
                const cell = e.target.closest('.bayer-cell');
                if (!cell) return;
                const row = parseInt(cell.getAttribute('data-row'), 10);
                const col = parseInt(cell.getAttribute('data-col'), 10);
                // If cell already has a placement, clicking removes it
                if (gridState[row][col]) {
                    placeAt(cell, row, col, gridState[row][col]);
                    return;
                }
                if (!selectedColor) {
                    speak('Select a color first');
                    cell.classList.add('invalid');
                    setTimeout(() => cell.classList.remove('invalid'), 250);
                    return;
                }
                placeAt(cell, row, col, selectedColor);
            });

            grid.addEventListener('mouseover', function(e) {
                const cell = e.target.closest('.bayer-cell');
                if (!cell) return;
                const row = parseInt(cell.getAttribute('data-row'), 10);
                const col = parseInt(cell.getAttribute('data-col'), 10);
                if (!gridState[row][col] && selectedColor && selectedColor === requiredAt(row, col)) {
                    cell.classList.add('hover-allowed');
                }
            });
            grid.addEventListener('mouseout', function(e) {
                const cell = e.target.closest('.bayer-cell');
                if (!cell) return;
                cell.classList.remove('hover-allowed');
            });

            // Keyboard support
            grid.addEventListener('keydown', function(e) {
                const active = document.activeElement;
                if (!active || !active.classList.contains('bayer-cell')) return;
                const row = parseInt(active.getAttribute('data-row'), 10);
                const col = parseInt(active.getAttribute('data-col'), 10);

                const moveFocus = (r, c) => {
                    const next = grid.querySelector(`.bayer-cell[data-row="${r}"][data-col="${c}"]`);
                    if (next) next.focus();
                };

                switch (e.key) {
                    case 'ArrowUp': e.preventDefault(); if (row > 0) moveFocus(row - 1, col); break;
                    case 'ArrowDown': e.preventDefault(); if (row < 3) moveFocus(row + 1, col); break;
                    case 'ArrowLeft': e.preventDefault(); if (col > 0) moveFocus(row, col - 1); break;
                    case 'ArrowRight': e.preventDefault(); if (col < 3) moveFocus(row, col + 1); break;
                    case 'r': case 'R': selectedColor = 'R'; updatePaletteUI(); speak('Red selected'); break;
                    case 'g': case 'G': selectedColor = 'G'; updatePaletteUI(); speak('Green selected'); break;
                    case 'b': case 'B': selectedColor = 'B'; updatePaletteUI(); speak('Blue selected'); break;
                    case 'Enter': case ' ': e.preventDefault(); if (selectedColor) placeAt(active, row, col, selectedColor); else speak('Select a color first'); break;
                    case 'Backspace': case 'Delete': e.preventDefault(); if (gridState[row][col]) { placeAt(active, row, col, gridState[row][col]); } break;
                }
            });

            if (hintToggle) {
                hintToggle.addEventListener('click', function() {
                    const showing = challenge.classList.toggle('hint-hidden');
                    const isExpanded = !showing;
                    this.textContent = isExpanded ? 'Hide Hint' : 'Show Hint';
                    this.setAttribute('aria-expanded', String(isExpanded));
                });
                // Start with hint hidden
                challenge.classList.add('hint-hidden');
            }

            if (resetBtn) {
                resetBtn.addEventListener('click', function() { resetAll(true); });
            }

            if (startQuizBtn && quizBlock) {
                startQuizBtn.addEventListener('click', function() {
                    quizBlock.style.display = 'block';
                    quizBlock.classList.add('animate-in');
                    quizBlock.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            }

            // Initialize UI
            updatePaletteUI();
        })();
    </script>
</body>
</html>

